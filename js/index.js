$(function(){var e=localStorage.getItem("code-txt");if(e)$("#code").val(e);else{var e="1/2+1/2;\n2323*232/34234+(22+5);\n(232+7)*6;";$("#code").val(e),localStorage.setItem("code-txt",e)}}),String.prototype.allTrim=function(){return this.replace(/(\s*)/g,"")};var code=[],tokens={PLUS:0,MINUS:1,TIMES:2,DIV:3,LP:4,RP:5,NUM_OR_ID:6,SEMI:7,UNKNOWN_SYMBOL:"Error",NONTERMINAL:"term"},opTable=[[1,1,-1,-1,-1,1,-1],[1,1,-1,-1,-1,1,-1],[1,1,1,1,-1,1,-1],[1,1,1,1,-1,1,-1],[-1,-1,-1,-1,-1,0,-1],[1,1,1,1,-2,1,-2],[1,1,1,1,-2,1,-2]],showInfo=function(e){$("#info").text(e)},getCode=function(){var e=$("#code").val().trim();code=e.split("\n")},drawLexTable=function(e,t){var n=document.createElement("table");n.className="table table-bordered lex";for(var r="<thead><th>Type</th><th>Token</th></thead>",a="<tbody>",o=0,c=e.length;o<c;o++)a=a+"<tr><td>"+e[o].type+"</td><td>"+e[o].ch+"</td></tr>";return a+="<tbody>",n.innerHTML=r+a,n},drawopDrw=function(e){var t=document.createElement("table");t.className="table table-bordered op";for(var n="<thead><th>Stack S</th><th>Relation</th><th>Input String</th><th>Reduce Rules</th></thead>",r="<tbody>",a=0,o=e.length;a<o;a++){var c=e[a].relation;c=0===c?"=":1===c?">":c===-1?"<":" ",r=r+"<tr><td>"+e[a].stackString+"</td><td>"+c+"</td><td>"+e[a].inputString+"</td><td>"+e[a].redueRule+"</td></tr>"}return r+="<tbody>",t.innerHTML=n+r,t},drawTree=function(e,t){var n=500,r=500,a=d3.layout.tree().size([n,r-200]).separation(function(e,t){return e.parent==t.parent?1:2}),o=d3.svg.diagonal().projection(function(e){return[e.y,e.x]}),c=d3.select(t).append("svg").attr("width",n).attr("height",r).append("g").attr("transform","translate(40,0)"),h=a.nodes(e),s=a.links(h),p=(c.selectAll(".link").data(s).enter().append("path").attr("class","link").attr("d",o),c.selectAll(".node").data(h).enter().append("g").attr("class","node").attr("transform",function(e){return"translate("+e.y+","+e.x+")"}));p.append("circle").attr("r",4.5),p.append("text").attr("dx",function(e){return e.children?-8:8}).attr("dy",3).style("text-anchor",function(e){return e.children?"end":"start"}).text(function(e){return e.name})},lexer=function(e){for(var t=[],n=[],r=function(e){switch(e){case"+":return tokens.PLUS;case"-":return tokens.MINUS;case"*":return tokens.TIMES;case"/":return tokens.DIV;case"(":return tokens.LP;case")":return tokens.RP;case";":return tokens.SEMI;default:return $.isNumeric(e)?tokens.NUM_OR_ID:tokens.UNKNOWN_SYMBOL}},a=-1,o=0,c=e.length;o<c;o++){var h=e[o],s=r(h);s!=tokens.NUM_OR_ID?s==tokens.UNKNOWN_SYMBOL?(t.push({type:tokens.UNKNOWN_SYMBOL,ch:h}),n.push({type:"Unknown Symbol",ch:h})):(a>=0&&(t.push({type:tokens.NUM_OR_ID,ch:a}),a=-1),t.push({type:s,ch:h})):a=a==-1?parseInt(h):10*a+parseInt(h)}return a>=0&&t.push({type:tokens.NUM_OR_ID,ch:a}),[t,n]},oppr=function(e){for(var t=[{type:tokens.SEMI,ch:";"}],n="",r="",a="",o=[],c=function(){for(var e=t.length-1;e>=0;e--)if(t[e].type!=tokens.NONTERMINAL)return e},h=function(e,t){return e==tokens.SEMI?-1:t==tokens.SEMI?1:opTable[e][t]},s=function(){for(var e=0,n=t.length,r="";e<n;e++)r+=t[e].ch;return r},p=function(){for(var t=0,n=e.length,r="";t<n;t++)r+=e[t].ch;return r},l=function(){var e=t.pop(),n=t.pop(),r="";if(e.type==tokens.NUM_OR_ID)if(n.type==tokens.SEMI||n.type==tokens.LP)t.push(n),t.push({type:tokens.NONTERMINAL,ch:"F"}),a="F -> i",o.push({name:"F",children:[{name:e.ch}]});else{switch(n.ch){case"+":r="T",a="T -> i",o.push({name:"T",children:[{name:e.ch}]});break;case"-":r="T",a="T -> i",o.push({name:"T",children:[{name:e.ch}]});break;case"*":r="F",a="F -> i",o.push({name:"F",children:[{name:e.ch}]});break;case"/":r="F",a="F -> i",o.push({name:"F",children:[{name:e.ch}]})}t.push(n),t.push({type:tokens.NONTERMINAL,ch:r})}else if("F"==e.ch)if(ch3=t.pop(),"*"==n.ch&&"TF".includes(ch3.ch)){t.push({type:tokens.NONTERMINAL,ch:"T"});var c=o.pop(),h=o.pop();o.push({name:"T",children:[h,{name:"*"},c]}),a="T -> "+ch3.ch+" * "+e.ch}else if("/"==n.ch&&"TF".indexOf(ch3.ch)>-1){t.push({type:tokens.NONTERMINAL,ch:"T"}),a="T -> "+ch3.ch+" / "+e.ch;var c=o.pop(),h=o.pop();o.push({name:"T",children:[h,{name:"/"},c]})}else{t.push(ch3),t.push(n),t.push({type:tokens.NONTERMINAL,ch:"T"}),a="T -> F";var c=o.pop();o.push({name:"T",children:c})}else if("T"==e.ch)if(ch3=t.pop(),"+"==n.ch&&"ETF".includes(ch3.ch)){t.push({type:tokens.NONTERMINAL,ch:"E"}),a="E -> "+ch3.ch+" + "+e.ch;var c=o.pop(),h=o.pop();o.push({name:"E",children:[h,{name:"+"},c]})}else if("-"==n.ch&&"EFT".includes(ch3.ch)){t.push({type:tokens.NONTERMINAL,ch:"E"}),a="E -> "+ch3.ch+" - "+e.ch;var c=o.pop(),h=o.pop();o.push({name:"E",children:[h,{name:"-"},c]})}else console.log("555");else if(")"==e.ch){if("E"==n.ch&&(ch3=t.pop(),"("==ch3.ch)){t.push({type:tokens.NONTERMINAL,ch:"F"}),a="F -> (E)";var c=o.pop();o.push({name:"F",children:[{name:"("},c,{name:")"}]})}}else console.log("语法错误")},i=[];;){var d=p(),u=s();r=t[c()];var f=e.shift();if(r.type==tokens.SEMI&&f.type==tokens.SEMI&&t[t.length-1].type==tokens.NONTERMINAL){var u=s();i.push({stackString:u,relation:" ",inputString:d,redueRule:" "});break}var n=h(r.type,f.type);n<=0?(t.push(f),i.push({stackString:u,relation:n,inputString:d,redueRule:" "})):(e.unshift(f),l(),i.push({stackString:u,relation:n,inputString:d,redueRule:a}))}return[i,o]},drawErrorBox=function(e){var t=0,n=e.length,r=document.createElement("div");r.className="alert alert-danger fade in";for(var a="";t<n;t++)a+="<h4><strong>Error: </strong>"+e[t].type+': "'+e[t].ch+'"</h4>';return r.innerHTML=a,r},handleLexer=function(){$("#opTb").hide();$("#code").val();getCode(),$("#info").html("");for(var e=0,t=code.length;e<t;e++){var n=lexer(code[e].allTrim()),r=n[0],a=n[1],o=drawLexTable(r);if($("#info").append('<h2 class="text-center">'+code[e]+"</h2>"),$("#info").append(o),a.length>0){var c=drawErrorBox(a);$("#info").append(c)}}},handleOP=function(){$("#opTb").hide();$("#code").val();getCode(),$("#info").html("");for(var e=0,t=code.length;e<t;e++){$("#info").append('<h2 class="text-center">'+code[e]+"</h2>");var n=lexer(code[e].allTrim()),r=n[0],a=n[1];if(a.length>0){var o=drawErrorBox(a);$("#info").append(o)}else{var c=oppr(r),h=c[0],s=drawopDrw(h);$("#info").append(s);var p=document.createElement("div");p.id="tree"+e,p.className="tree",$("#info").append(p);var l=c[1],i={name:l[0].name,children:l[0].children};drawTree(i,"#"+p.id)}}$(".op").find("td").each(function(e){e%4==2&&$(this).addClass("col_2"),e%4==0&&$(this).addClass("col_0")}),$(".op").find("th").each(function(e){})},handleDes=function(){$("#info").html("");var e=document.createElement("div");e.className="lexDes alert alert-info";var t="<h2>语法定义</h2>";t+="<h4>E->E+T|E-T|T</h4>",t+="<h4>T->T*F|T/F|F</h4>",t+="<h4>F->(E)|i</h4>",e.innerHTML=t,$("#info").append(e),$("#opTb").show()};$("#lexBtn").on("click",handleLexer),$("#opBtn").on("click",handleOP),$("#desBtn").on("click",handleDes),$("#code").on("keyup",function(){var e=$("#code").val();localStorage.setItem("code-txt",e)});